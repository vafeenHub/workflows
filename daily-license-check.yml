name: Daily License Check & Update

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'LICENSE*'
      - '.github/workflows/daily-license-check.yml'

permissions:
  contents: write

jobs:
  update-licenses:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    env:
      GH_TOKEN: ${{ secrets.PAT_ACCOUNT_TOKEN }}
      
    steps:
      - name: Checkout organization repo
        uses: actions/checkout@v4
        
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
      - name: Setup GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh
          
      - name: Find organization license
        id: find_license
        run: |
          echo "üîç Looking for license file..."
          
          for file in LICENSE LICENSE.md LICENSE.txt; do
            if [ -f "$file" ]; then
              ORG_LICENSE_FILE="$file"
              ORG_LICENSE=$(cat "$file")
              echo "ORG_LICENSE_FILE=$file" >> $GITHUB_OUTPUT
              echo "ORG_LICENSE_PATH=$PWD/$file" >> $GITHUB_OUTPUT
              echo "‚úÖ Found license file: $file"
              break
            fi
          done
          
          if [ -z "$ORG_LICENSE" ]; then
            echo "‚ùå No license file found"
            exit 1
          fi
          
          ORG_LICENSE_HASH=$(echo "$ORG_LICENSE" | sha256sum | awk '{print $1}')
          echo "ORG_LICENSE_HASH=$ORG_LICENSE_HASH" >> $GITHUB_OUTPUT
          
      - name: Process ALL public repositories
        env:
          ORG: ${{ github.repository_owner }}
          ORG_LICENSE_PATH: ${{ steps.find_license.outputs.ORG_LICENSE_PATH }}
          ORG_LICENSE_FILE: ${{ steps.find_license.outputs.ORG_LICENSE_FILE }}
          ORG_LICENSE_HASH: ${{ steps.find_license.outputs.ORG_LICENSE_HASH }}
        run: |
          echo "üè¢ Organization: $ORG"
          echo "üìÑ License: $ORG_LICENSE_FILE"
          echo "üîë Hash: $ORG_LICENSE_HASH"
          echo ""
          echo "üöÄ START PROCESSING ALL PUBLIC REPOSITORIES"
          echo "==========================================="
          
          # –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          process_repo() {
            local repo_full="$1"
            local is_fork="$2"
            local is_archived="$3"
            
            echo ""
            echo "üîç Processing: $repo_full"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–∫
            if [ "$is_fork" = "true" ]; then
              echo "   üç¥ –§–æ—Ä–∫ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
              return 0
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä—Ö–∏–≤–Ω—ã–π
            if [ "$is_archived" = "true" ]; then
              echo "   üì¶ –ê—Ä—Ö–∏–≤–Ω—ã–π - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
              return 0
            fi
            
            # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            git clone --depth 1 "https://x-access-token:$GH_TOKEN@github.com/$repo_full.git" /tmp/current_repo
            
            cd /tmp/current_repo
            
            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–∏—Ü–µ–Ω–∑–∏—é
            CURRENT_LICENSE=""
            CURRENT_HASH=""
            
            for lic_file in $ORG_LICENSE_FILE LICENSE LICENSE.md LICENSE.txt COPYING; do
              if [ -f "$lic_file" ]; then
                CURRENT_LICENSE="$lic_file"
                CURRENT_HASH=$(sha256sum "$lic_file" | awk '{print $1}')
                break
              fi
            done
            
            if [ -n "$CURRENT_LICENSE" ]; then
              # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ö—ç—à–∏
              if [ "$CURRENT_HASH" = "$ORG_LICENSE_HASH" ]; then
                echo "   ‚úÖ $CURRENT_LICENSE - –ù–ï –ò–ó–ú–ï–ù–Ø–ï–¢–°–Ø"
              else
                echo "   üîÑ $CURRENT_LICENSE -> $ORG_LICENSE_FILE - –û–ë–ù–û–í–õ–Ø–ï–ú"
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é
                cp "$ORG_LICENSE_PATH" "./$ORG_LICENSE_FILE"
                
                # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
                if [ "$CURRENT_LICENSE" != "$ORG_LICENSE_FILE" ]; then
                  rm -f "$CURRENT_LICENSE"
                fi
                
                # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                git add "$ORG_LICENSE_FILE"
                git commit -m "docs: update license to organization template"
                
                # –ü—É—à –∏–∑–º–µ–Ω–µ–Ω–∏–π
                echo "   üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
                git push origin HEAD
              fi
            else
              # –õ–∏—Ü–µ–Ω–∑–∏–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º
              echo "   üìù –ù–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏ - –î–û–ë–ê–í–õ–Ø–ï–ú"
              
              cp "$ORG_LICENSE_PATH" "./$ORG_LICENSE_FILE"
              git add "$ORG_LICENSE_FILE"
              git commit -m "docs: add $ORG_LICENSE_FILE from organization template"
              
              # –ü—É—à –∏–∑–º–µ–Ω–µ–Ω–∏–π
              echo "   üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
              git push origin HEAD
            fi
            
            # –û—á–∏—Å—Ç–∫–∞
            cd /
            rm -rf /tmp/current_repo
          }
          
          # –ü–æ–ª—É—á–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –í–°–ï —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
          PAGE=1
          
          while true; do
            echo ""
            echo "üìÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É $PAGE..."
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ñ–æ—Ä–∫–∞—Ö –∏ –∞—Ä—Ö–∏–≤–∞—Ö
            repos_json=$(gh api \
              --method GET \
              -H "Accept: application/vnd.github.v3+json" \
              "/orgs/$ORG/repos?type=public&per_page=100&page=$PAGE")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
            if [ -z "$repos_json" ] || [ "$repos_json" = "[]" ]; then
              echo "‚úÖ –í—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã"
              break
            fi
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            echo "$repos_json" | jq -r '.[] | "\(.full_name) \(.fork) \(.archived)"' | while read -r repo_info; do
              repo_full=$(echo "$repo_info" | awk '{print $1}')
              is_fork=$(echo "$repo_info" | awk '{print $2}')
              is_archived=$(echo "$repo_info" | awk '{print $3}')
              
              process_repo "$repo_full" "$is_fork" "$is_archived"
            done
            
            PAGE=$((PAGE + 1))
          done